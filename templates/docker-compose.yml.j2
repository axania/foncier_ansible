version: '3.3'

volumes:
  postgres:

# Define the services/containers to be run
services:

{% if is_datadog_on_docker %}
  datadog:
    restart: always
    image: datadog/docker-dd-agent:latest
    ports:
      - "8125:8125/udp"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro 
      - /proc/:/host/proc/:ro 
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro 
    environment:
      API_KEY: "{{ dd_key }}"
      SD_BACKEND: "docker"
      TAGS: "environment:{{ environment_name }},role:docker,product:foncier"
      DD_HOSTNAME: "{{ full_hostname }}"
      DD_PROCESS_AGENT_ENABLED: "{{ dd_process_agent_enabled }}"
{% endif %}

  foncier-ui:
    restart: always
    image: sogema-docker.jfrog.io/sogema/foncier-ui:{{ foncier_ui_image_version }}
    ports:
      - "4200:4200"
    environment:
      - API_URL=foncier-api:8280
      - WORKFLOW_URL=foncier-wf:8080
    depends_on:
      - foncier-api        
      - foncier-wf

  foncier-wf:
    restart: always
    image: sogema-docker.jfrog.io/sogema/foncier-wf:{{ foncier_wf_image_version }}
    ports:
      - "8581:8080"
    environment:
      DB_DRIVER: "org.postgresql.Driver"
      DB_URL: "jdbc:postgresql://{{ db_host }}:{{ db_port }}/process-engine"
      DB_USERNAME: "{{ db_user }}"
      DB_PASSWORD: "{{ db_pass }}"
      WAIT_FOR: "{{ db_host }}:{{ db_port }}"
    volumes:
      - ./custom-config/web.xml:/camunda/webapps/engine-rest/WEB-INF/web.xml
      - ./custom-config/keycloak.json:/camunda/webapps/engine-rest/WEB-INF/keycloak.json
      - ./custom-config/context.xml:/camunda/webapps/engine-rest/META-INF/context.xml

  foncier-api:
    restart: always
    image: sogema-docker.jfrog.io/sogema/foncier-api:{{ foncier_api_image_version }}
    ports:
      - "8280:8280"
    environment:
      DB_HOST: "{{ db_host }}"
      DB_PORT: "{{ db_port }}"
      DB_USER: "{{ db_user }}"
      DB_PASS: "{{ db_pass }}"
      DB_NAME: "{{ db_name }}"
      CAMUNDA_ENGINEREST_URL: {{ camunda_enginerest_url }}
      EDMS_USER: {{ edms_user }}
      EDMS_PASSWORD: {{ edms_password }}
      EDMS_DOMAIN: {{ edms_domain }}
      EDMS_SOURCE: {{ edms_source }}
      EDMS_ENABLED: '{{ edms_enabled }}'
      EDMS_TEMP_FILE_DIRECTORY: {{ edms_temp_file_directory }}
      EDMS_SERVER_BASE_FOLDER: {{ edms_server_base_folder }}
      EDMS_SHAREPOINT_SITE: {{ edms_sharepoint_site }}
      EDMS_SHAREPOINT_FOLDER: {{ edms_sharepoint_folder }}
      EDMS_ALFRESCO_SITE: {{ edms_alfresco_site }}
      EDMS_ALFRESCO_FOLDER: {{ edms_alfresco_folder }}
      EDMS_ALFRESCO_CONTAINER: {{ edms_alfresco_container }}
      MAIL_HOST: {{ mail_host }}
      MAIL_PORT: {{ mail_port }}
      MAIL_USERNAME: {{ mail_username }}
      MAIL_PASSWORD: {{ mail_password }}
      MAIL_PROTOCOL: {{ mail_protocol }}
      MAIL_DEFAULTENCODING: {{ mail_defaultencoding }}
      MAIL_SMTP_AUTH_ENABLED: '{{ mail_smtp_auth_enabled }}'
      MAIL_TLS_ENABLED: '{{ mail_tls_enabled }}'
      KEYCLOAK_AUTH_SERVER_URL: {{ keycloak_auth_server_url }}
      KEYCLOAK_REALM: {{ keycloak_realm }}
      KEYCLOAK_SSL_REQUIRED: '{{ keycloak_ssl_required }}'
      KEYCLOAK_API_CLIENT: {{ keycloak_api_client }}
      KEYCLOAK_API_CLIENT_SECRET: {{ keycloak_api_client_secret }}
      KEYCLOAK_API_CLIENT_ROLE: {{ keycloak_api_client_role }}
      KEYCLOAK_UI_CLIENT: {{ keycloak_ui_client }}
      RULES_BASE_URL: {{rules_base_url}}
      RULES_DEFAULT_TRAN_TYPE: {{rules_default_tran_type}}
      RULES_DEFAULT_TRAN_VERSION: {{rules_default_tran_version}}
      RULES_ENDPOINTS_TASK: {{rules_endpoints_task}}
      RULES_ENDPOINTS_PARTY: {{rules_endpoints_party}}
      RULES_ENDPOINTS_PARTY_GROUP: {{rules_endpoints_party_group}}
      RULES_ENDPOINTS_PARTY_MEMBER: {{rules_endpoints_party_member}}
      MALI_FOLIOS_PER_VOLUME: {{mali_folios_per_volume}}
    depends_on:
      - foncier-wf
      - foncier-db

  foncier-db:
    image: postgres:10.4-alpine
    restart: always
    volumes:
      - postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"      
    environment:
      POSTGRES_USER: "{{ db_user }}"
      POSTGRES_PASSWORD: "{{ db_pass }}"
      POSTGRES_DB: "{{ db_name }}"    
      PGDATA: /var/lib/postgresql/data/pgdata

{% if is_foncier_rules_api_enabled %}   
  foncier-rules-api:
    restart: always
    image: sogema-docker.jfrog.io/sogema/foncier-rules-api:{{foncier_rules_api_image_version}}
    ports:
      - "8082:8080"
      - "8001:8001"
    #volumes:
    #  - /data/drools/wb_git:/opt/jboss/wildfly/bin/.niogit
    #TODO map /usr/share/maven without loosing its content! believe user issue
    #TODO replace the admin password by loading from environment
    command: ["sh", "-c", "/opt/jboss/wildfly/bin/add-user.sh -a {{drools_workbench_user}} {{drools_workbench_pass}} && /opt/jboss/wildfly/bin/start_server.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 1m30s
      timeout: 10s
      retries: 3    
{% endif %}        